name: Playwright Tests CI - Simplified

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run flaky scan daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # Job 1: Smoke Tests (Guest + Auth) with Intelligent CI
  smoke-tests:
    name: ğŸš€ Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git diff
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ğŸ” Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            tests:
              - 'tests/**/*.spec.ts'
            app:
              - 'apps/**'
              - 'pages/**'
              - 'playwright.config.*'
              - 'package.json'
              - 'package-lock.json'
        
      - name: ğŸ§ª Run affected tests (by file)
        if: github.event_name == 'pull_request' && steps.changes.outputs.tests == 'true'
        run: |
          CHANGED_TESTS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^tests/.*\.spec\.ts$' || true)
          if [ -z "$CHANGED_TESTS" ]; then
            echo "No direct test files changed, running smoke..."
            npx playwright test --grep "@smoke" --project=guest-chromium
          else
            echo "Running affected tests:"
            echo "$CHANGED_TESTS"
            npx playwright test $CHANGED_TESTS --project=guest-chromium
          fi
        env:
          TEST_USER: ${{ secrets.TEST_USER }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      
      - name: ğŸ§ª Run smoke fallback (app/config changes)
        if: github.event_name == 'pull_request' && steps.changes.outputs.tests != 'true' && steps.changes.outputs.app == 'true'
        run: npx playwright test --grep "@smoke" --project=guest-chromium
        env:
          TEST_USER: ${{ secrets.TEST_USER }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
      
      - name: ğŸ§ª Default smoke (push or no changes detected)
        if: github.event_name != 'pull_request' || (steps.changes.outputs.tests != 'true' && steps.changes.outputs.app != 'true')
        run: npm run test:smoke
        env:
          TEST_USER: ${{ secrets.TEST_USER }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        
      - name: ğŸ“Š Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-smoke-tests
          path: playwright-report
          retention-days: 7
          
      - name: ğŸ“ˆ Generate metrics & trending
        if: always()
        run: |
          mkdir -p reports
          npm run metrics:trending || echo "Metrics generation skipped (no results.json)"
          npm run visual:report || echo "No visual diffs to report"
        
      - name: ğŸ“ Add metrics to job summary
        if: always()
        run: |
          if [ -f reports/summary.json ]; then
            echo "## ğŸ“Š Test Metrics" >> $GITHUB_STEP_SUMMARY
            cat reports/summary.json | jq -r '"**Total:** \(.total) | **Passed:** \(.passed) (\(.passRate)%) | **Failed:** \(.failed) | **Skipped:** \(.skipped) | **Flaky:** \(.flaky) (\(.flakyRate)%) | **Duration:** \(.duration)"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f reports/visual-diff-report.html ]; then
              echo "âš ï¸ Visual differences detected. See artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
      - name: ğŸ“Š Upload metrics reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-smoke-tests
          path: |
            reports/summary.json
            reports/history.json
            reports/visual-diff-report.html
          retention-days: 30
          if-no-files-found: ignore
          
      - name: ğŸ” Upload traces & media
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: traces-and-media-smoke-tests
          path: |
            test-results
            **/*-trace.zip
          retention-days: 14
          if-no-files-found: ignore
          
      - name: ğŸ“ Job summary
        if: always()
        run: |
          echo "## âœ… Resultados smoke-tests" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- Reporte HTML: (artefacto) **playwright-report-smoke-tests**" >> $GITHUB_STEP_SUMMARY
          echo "- Traces/Videos: (artefacto) **traces-and-media-smoke-tests**" >> $GITHUB_STEP_SUMMARY

  # Job 2: Regression Tests
  regression-tests:
    name: ğŸ”„ Regression Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ğŸ§ª Run regression tests (includes a11y, visual, auth)
        run: npm run test:regression
        env:
          TEST_USER: ${{ secrets.TEST_USER }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        
      - name: ğŸ“Š Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-regression-tests
          path: playwright-report
          retention-days: 7
          
      - name: ğŸ“ˆ Generate metrics & trending
        if: always()
        run: |
          mkdir -p reports
          npm run metrics:trending || echo "Metrics generation skipped (no results.json)"
          npm run visual:report || echo "No visual diffs to report"
        
      - name: ğŸ“ Add metrics to job summary
        if: always()
        run: |
          if [ -f reports/summary.json ]; then
            echo "## ğŸ“Š Test Metrics" >> $GITHUB_STEP_SUMMARY
            cat reports/summary.json | jq -r '"**Total:** \(.total) | **Passed:** \(.passed) (\(.passRate)%) | **Failed:** \(.failed) | **Skipped:** \(.skipped) | **Flaky:** \(.flaky) (\(.flakyRate)%) | **Duration:** \(.duration)"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f reports/visual-diff-report.html ]; then
              echo "âš ï¸ Visual differences detected. See artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
      - name: ğŸ“Š Upload metrics reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-regression-tests
          path: |
            reports/summary.json
            reports/history.json
            reports/visual-diff-report.html
          retention-days: 30
          if-no-files-found: ignore
          
      - name: ğŸ” Upload traces & media
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: traces-and-media-regression-tests
          path: |
            test-results
            **/*-trace.zip
          retention-days: 14
          if-no-files-found: ignore
          
      - name: ğŸ“ Job summary
        if: always()
        run: |
          echo "## âœ… Resultados regression-tests" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- Reporte HTML: (artefacto) **playwright-report-regression-tests**" >> $GITHUB_STEP_SUMMARY
          echo "- Traces/Videos: (artefacto) **traces-and-media-regression-tests**" >> $GITHUB_STEP_SUMMARY

  # Job 3: API Tests
  api-tests:
    name: ğŸ”Œ API Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ğŸ§ª Run API tests
        run: npm run test:api
        
      - name: ğŸ§ª Run Mock tests  
        run: npm run test:mock
        
      - name: ğŸ§ª Run Edge case tests
        run: npm run test:edge
        
      - name: ğŸ“Š Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-api-tests
          path: playwright-report
          retention-days: 7
          
      - name: ğŸ“ˆ Generate metrics & trending
        if: always()
        run: |
          mkdir -p reports
          npm run metrics:trending || echo "Metrics generation skipped (no results.json)"
        
      - name: ğŸ“ Add metrics to job summary
        if: always()
        run: |
          if [ -f reports/summary.json ]; then
            echo "## ğŸ“Š Test Metrics" >> $GITHUB_STEP_SUMMARY
            cat reports/summary.json | jq -r '"**Total:** \(.total) | **Passed:** \(.passed) (\(.passRate)%) | **Failed:** \(.failed) | **Skipped:** \(.skipped) | **Flaky:** \(.flaky) (\(.flakyRate)%) | **Duration:** \(.duration)"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f reports/visual-diff-report.html ]; then
              echo "âš ï¸ Visual differences detected. See artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
      - name: ğŸ“Š Upload metrics reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-regression-tests
          path: |
            reports/summary.json
            reports/history.json
            reports/visual-diff-report.html
          retention-days: 30
          if-no-files-found: ignore
          
      - name: ğŸ“Š Upload metrics reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-api-tests
          path: |
            reports/summary.json
            reports/history.json
          retention-days: 30
          if-no-files-found: ignore
          
      - name: ğŸ” Upload traces & media
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: traces-and-media-api-tests
          path: |
            test-results
            **/*-trace.zip
          retention-days: 14
          if-no-files-found: ignore
          
      - name: ğŸ“ Job summary
        if: always()
        run: |
          echo "## âœ… Resultados api-tests" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- Reporte HTML: (artefacto) **playwright-report-api-tests**" >> $GITHUB_STEP_SUMMARY
          echo "- Traces/Videos: (artefacto) **traces-and-media-api-tests**" >> $GITHUB_STEP_SUMMARY

  # Job 4: Flaky Test Detection (Daily + On Demand)
  flaky-scan:
    name: ğŸ” Flaky Test Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[flaky-scan]')
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ğŸ” Run flaky tests (5x repetition, 1 worker)
        run: npm run test:flaky
        continue-on-error: true
        env:
          TEST_USER: ${{ secrets.TEST_USER }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        
      - name: ğŸ“Š Upload flaky test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flaky-scan-report
          path: |
            reports/
            test-results/
          retention-days: 30
          
      - name: ğŸ“ Generate flaky test summary
        if: always()
        run: |
          echo "## ğŸ” Flaky Test Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** 5 repetitions with 1 worker" >> $GITHUB_STEP_SUMMARY
          echo "**Tags scanned:** @flaky, @edge, @visual" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Check uploaded artifacts for detailed flaky test report" >> $GITHUB_STEP_SUMMARY

  # Job 5: Test Summary
  test-summary:
    name: ğŸ“‹ Test Results Summary
    runs-on: ubuntu-latest
    needs: [smoke-tests, regression-tests, api-tests]
    if: always() && github.event_name != 'schedule'
    steps:
      - name: ğŸ“Š Generate enriched test summary
        run: |
          echo "## ğŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Smoke | ${{ needs.smoke-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Guest + Authenticated critical paths |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ Regression | ${{ needs.regression-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Full suite with a11y, visual, auth |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”Œ API | ${{ needs.api-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | API contracts and mocks |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download test artifacts from the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.smoke-tests.result }}" == "failure" ]; then
            echo "- ğŸ“¹ **Smoke Videos** - Test failure recordings" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¸ **Smoke Screenshots** - Failure screenshots" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” **Smoke Traces** - Detailed execution traces" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.regression-tests.result }}" == "failure" ]; then
            echo "- ğŸ“¹ **Regression Videos** - Test failure recordings" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¸ **Regression Screenshots** - Failure screenshots" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” **Regression Traces** - Detailed execution traces" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.api-tests.result }}" == "failure" ]; then
            echo "- ğŸ” **API Traces** - API test execution traces" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **HTML Reports** available in artifacts for all test suites" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.smoke-tests.result }}" == "success" ] && [ "${{ needs.regression-tests.result }}" == "success" ] && [ "${{ needs.api-tests.result }}" == "success" ]; then
            echo "### ğŸ‰ All test suites passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ¨ No failures detected. All tests completed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ” Check the artifacts above for:" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¹ Video recordings of failures" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¸ Screenshots at failure points" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ” Detailed traces for debugging" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š Complete HTML reports" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 6: Component Tests (Props + Network + A11y Golden)
  component-tests:
    name: ğŸ§© Component Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ğŸ§© Run component tests (props â†’ DOM + network mocking)
        run: npm run test:components
        
      - name: ğŸ“Š Upload component test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-component-tests
          path: playwright-report
          retention-days: 7
          
      - name: ğŸ“ˆ Generate metrics for components
        if: always()
        run: |
          mkdir -p reports
          npm run metrics:trending || echo "Metrics generation skipped"
          npm run visual:report || echo "No visual diffs"
        
      - name: ğŸ“ Add component metrics to job summary
        if: always()
        run: |
          echo "## ğŸ§© Component Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Types:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Props â†’ DOM validation" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Network mocking tests" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ A11y golden baseline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/summary.json ]; then
            cat reports/summary.json | jq -r '"**Total:** \(.total) | **Passed:** \(.passed) (\(.passRate)%) | **Failed:** \(.failed) | **Flaky:** \(.flaky) (\(.flakyRate)%)"' >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ğŸ” Upload component traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: traces-component-tests
          path: test-results
          retention-days: 14
          if-no-files-found: ignore

  # Job 7: Publish Report to GitHub Pages
  publish-report:
    name: ğŸ“„ Publish Report to GitHub Pages
    needs: regression-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download regression report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-regression-tests
          path: ./site
          
      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          commit_message: 'Deploy Playwright report from ${{ github.sha }}'