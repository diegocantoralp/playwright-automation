name: Playwright Tests CI - Simplified

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run flaky scan daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # Job 1: Smoke Tests (Guest + Auth)
  smoke-tests:
    name: ðŸš€ Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ðŸ§ª Run smoke tests (Guest + Auth)
        run: npm run test:smoke
        env:
          TEST_USER: ${{ secrets.TEST_USER }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        
      - name: ðŸ“Š Upload smoke test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: |
            reports/
            test-results/
          retention-days: 7

  # Job 2: Regression Tests
  regression-tests:
    name: ðŸ”„ Regression Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ðŸ§ª Run regression tests (includes a11y, visual, auth)
        run: npm run test:regression
        env:
          TEST_USER: ${{ secrets.TEST_USER }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        
      - name: ðŸ“Š Upload regression test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-test-report
          path: |
            reports/
            test-results/
          retention-days: 7
          
      - name: ðŸ“¸ Upload visual screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-screenshots
          path: |
            tests/**/*-actual.png
            tests/**/*-diff.png
            tests/**/screenshots/
          retention-days: 30

  # Job 3: API Tests (Optional - can run in parallel)
  api-tests:
    name: ðŸ”Œ API Tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ðŸ§ª Run API tests
        run: npm run test:api
        
      - name: ðŸ§ª Run Mock tests  
        run: npm run test:mock
        
      - name: ðŸ§ª Run Edge case tests
        run: npm run test:edge
        
      - name: ðŸ“Š Upload API test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: reports/
          retention-days: 7

  # Job 4: Flaky Test Detection (Daily + On Demand)
  flaky-scan:
    name: ðŸ” Flaky Test Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[flaky-scan]')
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ðŸ“¦ Install dependencies
        run: npm ci
        
      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium
        
      - name: ðŸ” Run flaky tests (5x repetition, 1 worker)
        run: npm run test:flaky
        continue-on-error: true
        env:
          TEST_USER: ${{ secrets.TEST_USER }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        
      - name: ðŸ“Š Upload flaky test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flaky-scan-report
          path: |
            reports/
            test-results/
          retention-days: 30
          
      - name: ðŸ“ Generate flaky test summary
        if: always()
        run: |
          echo "## ðŸ” Flaky Test Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** 5 repetitions with 1 worker" >> $GITHUB_STEP_SUMMARY
          echo "**Tags scanned:** @flaky, @edge, @visual" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Check uploaded artifacts for detailed flaky test report" >> $GITHUB_STEP_SUMMARY

  # Job 5: Test Summary
  test-summary:
    name: ðŸ“‹ Test Results Summary
    runs-on: ubuntu-latest
    needs: [smoke-tests, regression-tests, api-tests]
    if: always() && github.event_name != 'schedule'
    steps:
      - name: ðŸ“Š Generate test summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Smoke | ${{ needs.smoke-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Guest + Authenticated critical paths |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Regression | ${{ needs.regression-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Full suite with a11y, visual, auth |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”Œ API | ${{ needs.api-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | API contracts and mocks |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.smoke-tests.result }}" == "success" ] && [ "${{ needs.regression-tests.result }}" == "success" ] && [ "${{ needs.api-tests.result }}" == "success" ]; then
            echo "### ðŸŽ‰ All test suites passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some tests failed - Check reports" >> $GITHUB_STEP_SUMMARY
          fi